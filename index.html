<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cup Mapper</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <!-- ========= Top Bar ========= -->
  <header class="topbar">
    <div>
      <h1 class="app-title">Cup Mapper</h1>
      <span class="app-subtitle">Prep images for limited inks & AI vectorizing</span>
    </div>
    <div class="topbar__right">
      <button id="btnOpenHelp" class="btn btn-ghost">Help</button>
      <button id="btnOpenAbout" class="btn btn-ghost">About</button>
    </div>
  </header>

  <!-- ========= Main Layout ========= -->
  <div class="layout">
    <!-- ----- Controls (left) ----- -->
    <aside class="panel panel--controls">
      <!-- Stage 1: Upload -->
      <section class="card">
        <div class="card__header">
          <h2>1) Upload</h2>
          <p class="muted">AI image or photo</p>
        </div>
        <div class="card__body">
          <!-- HERO: big original preview (always visible on mobile) -->
          <div class="heroWrap">
            <canvas id="heroCanvas" width="0" height="0" aria-label="Original image preview"></canvas>
          </div>

          <div class="row wrap uploader">
            <input id="fileInput" type="file" accept="image/*" />
          </div>

          <div class="uploader__row">
            <label>Max width <input id="maxW" type="number" value="1600" /></label>
            <div class="preview-zoom">
              <label>Zoom</label>
              <input id="zoom" type="range" min="10" max="400" value="100" />
              <span id="zoomLabel">100%</span>
            </div>
            <button id="btnZoomFit" class="btn">Fit</button>
            <button id="btnZoom100" class="btn">100%</button>
          </div>

          <div class="row wrap" style="margin-top:10px;">
            <button id="btnLoadSample" class="btn">Load sample</button>
            <button id="btnClear" class="btn btn-danger">Clear</button>
          </div>
        </div>
      </section>

      <!-- Stage 2: Original Palette -->
      <section class="card">
        <div class="card__header">
          <h2>2) Original palette</h2>
        </div>
        <div class="card__body">
          <div class="row wrap">
            <label>Clusters <input id="clusters" type="number" min="2" max="16" value="8" /></label>
            <button id="btnExtract" class="btn">Extract</button>
            <button id="btnEyedrop" class="btn">Eyedrop</button>
          </div>
          <div id="origPalette" class="swatch-grid" aria-live="polite"></div>
        </div>
      </section>

      <!-- Stage 3: Restricted Palette -->
      <section class="card">
        <div class="card__header">
          <h2>3) Restricted palette</h2>
        </div>
        <div class="card__body">
          <div class="row wrap">
            <button id="btnRefreshRestricted" class="btn">From original</button>
            <label class="switch"><input id="allowWhite" type="checkbox" /> Allow white</label>
            <button id="btnAddRestricted" class="btn">Add</button>
          </div>

          <div id="restrictedPalette" class="swatch-grid" aria-live="polite"></div>

          <div class="divider"></div>
          <div class="row wrap">
            <button id="btnSaveKit" class="btn">Save kit</button>
            <select id="kitSelect"></select>
            <button id="btnLoadKit" class="btn">Load</button>
            <button id="btnDeleteKit" class="btn btn-danger">Delete</button>
          </div>
        </div>
      </section>

      <!-- Stage 4a: Manual Mixing (no smart mixing) -->
      <section class="card">
        <div class="card__header">
          <h2>4a) Manual mixing</h2>
          <p class="muted">Replace one original color with tiled inks (2–3) using patterns & logical pixel size</p>
        </div>
        <div class="card__body">
          <div class="row wrap">
            <label>Replace color
              <select id="replaceSrc"></select>
            </label>
          </div>

          <div class="row wrap">
            <label>Block size <input id="blockSize" type="number" min="2" max="64" value="6" /></label>
            <label>Logical pixel size <input id="mixCellSize" type="number" min="1" value="1" /></label>
            <label>Pattern
              <select id="mixPattern">
                <option value="blue">Blue noise</option>
                <option value="checker">Checker</option>
                <option value="stripes-h">Stripes (H)</option>
                <option value="stripes-v">Stripes (V)</option>
                <option value="bayer">Bayer dither</option>
              </select>
            </label>
          </div>

          <div id="mixInks" class="mix-grid"></div>

          <div class="row wrap">
            <button id="btnAddMixInk" class="btn">Add ink</button>
            <button id="btnClearMix" class="btn btn-danger">Clear</button>
            <span id="mixTotal" class="spacer">Total: 0%</span>
          </div>

          <button id="btnPreviewMix" class="btn btn-primary">Preview replacement swatch</button>
          <canvas id="mixPreview" width="180" height="90" style="margin-top:8px;"></canvas>
        </div>
      </section>

      <!-- Stage 4b: Pattern Replace (background + shapes) -->
      <section class="card">
        <div class="card__header">
          <h2>4b) Pattern replace</h2>
          <p class="muted">Repaint one original color as a background + overlaid shapes (e.g., white BG with staggered red dots)</p>
        </div>
        <div class="card__body">
          <div class="row wrap">
            <label class="switch"><input id="prEnable" type="checkbox" /> Enable pattern replace</label>
          </div>

          <div class="row wrap">
            <label>Replace color
              <select id="prSrc"></select>
            </label>
            <label>Background
              <input id="prBg" type="color" value="#FFFFFF" />
            </label>
            <label>Shape
              <select id="prShape">
                <option value="dots">Dots</option>
                <option value="squares">Squares</option>
                <option value="stripes-h">Stripes (H)</option>
                <option value="stripes-v">Stripes (V)</option>
                <option value="checker">Checker</option>
                <option value="cross">Cross</option>
              </select>
            </label>
            <label>Shape color
              <input id="prShapeColor" type="color" value="#FF0000" />
            </label>
          </div>

          <div class="row wrap">
            <label>Cell size <input id="prCell" type="number" min="2" max="128" value="12" /></label>
            <label>Shape size
              <input id="prShapeSize" type="range" min="10" max="100" value="70" />
            </label>
            <label class="switch"><input id="prStagger" type="checkbox" /> Stagger rows</label>
          </div>

          <div class="row wrap" style="margin-top:6px;">
            <button id="btnPreviewPattern" class="btn">Preview pattern swatch</button>
          </div>
          <canvas id="prPreview" width="180" height="90" style="margin-top:8px;"></canvas>
        </div>
      </section>

      <!-- Stage 5: Map to Palette (preview resolution selectable) -->
      <section class="card">
        <div class="card__header">
          <h2>5) Map to palette</h2>
        </div>
        <div class="card__body">
          <div class="row wrap">
            <label>ΔL weight <input id="wL" type="number" value="1" step="0.1" /></label>
            <label>ΔC weight <input id="wC" type="number" value="1" step="0.1" /></label>
            <label class="switch"><input id="dither" type="checkbox" /> Dither</label>
            <label class="switch"><input id="sharpen" type="checkbox" /> Sharpen</label>
            <label>Preview scale
              <select id="previewRes">
                <option value="1">100%</option>
                <option value="0.75">75%</option>
                <option value="0.5">50%</option>
                <option value="0.33">33%</option>
                <option value="0.25">25%</option>
              </select>
            </label>
          </div>

          <button id="btnMap" class="btn btn-primary">Apply mapping</button>
          <div id="mapProgress" class="progress hidden" style="margin-top:8px;">
            <div class="spinner"></div>
            <span id="mapProgressLabel">Processing…</span>
          </div>
        </div>
      </section>

      <!-- Stage 6: Export (UPDATED) -->
      <section class="card">
        <div class="card__header">
          <h2>6) Export</h2>
        </div>
        <div class="card__body">
          <div class="row wrap" style="align-items:flex-end; gap:12px;">
            <div class="fieldset">
              <legend>Resolution preset</legend>
              <div class="row" style="gap:8px;">
                <input id="resPreset" type="range" min="0" max="3" step="1" value="1" aria-label="Resolution preset">
                <div class="marks">
                  <span>Low</span><span>Med</span><span>High</span><span>Max</span>
                </div>
              </div>
            </div>

            <div class="fieldset">
              <legend>Scale (×)</legend>
              <!-- allow higher numbers now -->
              <input id="exportScale" type="number" min="1" max="32" step="1" value="4">
            </div>

            <div class="switch">
              <input id="exportTransparent" type="checkbox">
              <label for="exportTransparent">Transparent</label>
            </div>

            <button id="btnExportPNG" class="btn btn-primary">Export PNG</button>
            <button id="btnExportSVG" class="btn">Export SVG</button>
            <a id="downloadLink" class="btn" style="display:none">Download</a>
          </div>

          <!-- NEW: export progress -->
          <div id="exportProgress" class="progress hidden" style="margin-top:10px;">
            <div class="spinner"></div>
            <span id="exportProgressLabel">Exporting…</span>
          </div>
        </div>
      </section>

      <!-- Stage 7: Projects -->
      <section class="card">
        <div class="card__header">
          <h2>7) Projects</h2>
        </div>
        <div class="card__body">
          <div class="row wrap">
            <button id="btnSaveProject" class="btn">Save</button>
            <select id="projectSelect"></select>
            <button id="btnLoadProject" class="btn">Load</button>
            <button id="btnDeleteProject" class="btn btn-danger">Delete</button>
          </div>
        </div>
      </section>
    </aside>

    <!-- ----- Preview (right) ----- -->
    <main class="panel panel--preview">
      <div class="canvas-stack">

        <figure class="canvas-wrap">
          <figcaption class="figcaption">Source image</figcaption>
          <div id="srcScroll" class="canvas-scroll">
            <canvas id="srcCanvas" width="0" height="0"></canvas>
          </div>
        </figure>

        <figure class="canvas-wrap">
          <figcaption class="figcaption">Mapped image (preview)</figcaption>
          <div id="outScroll" class="canvas-scroll">
            <canvas id="outCanvas" width="0" height="0"></canvas>
          </div>
        </figure>

      </div>
    </main>
  </div>

  <!-- ========= Footer / Status ========= -->
  <footer class="statusbar">
    <span id="statusText">Ready</span>
  </footer>
  <div id="toastHost" class="toast-host"></div>

  <!-- ========= Template(s) ========= -->
  <template id="tplMixRow">
    <div class="mix-row">
      <select class="mix-ink-select"></select>
      <input type="range" class="mix-ink-range" min="0" max="100" value="0" />
      <span class="mix-ink-val">0%</span>
      <button class="mix-ink-remove btn btn-danger" title="Remove">×</button>
    </div>
  </template>

  <!-- ========= Modals ========= -->
  <dialog id="dlgHelp" class="modal">
    <div class="modal__header"><h3>Help</h3></div>
    <div class="modal__body">
      <ol class="help-steps">
        <li>Upload an image (AI or photo). The big preview shows up top.</li>
        <li>Extract the original palette and tweak swatches as needed.</li>
        <li>Build your restricted palette; enable/disable inks; save as kits.</li>
        <li>Optional 4a: Manual mix — replace one color using 2–3 inks with patterns.</li>
        <li>Optional 4b: Pattern replace — repaint a color as background + shapes.</li>
        <li>Map to palette (pick preview scale) and review on the right.</li>
        <li>Export PNG/SVG and vectorize in Illustrator.</li>
      </ol>
    </div>
    <div class="modal__footer"><button id="btnCloseHelp" class="btn">Close</button></div>
  </dialog>

  <dialog id="dlgAbout" class="modal">
    <div class="modal__header"><h3>About</h3></div>
    <div class="modal__body">
      <p>Cup Mapper helps convert complex art into limited-ink imagery designed for reliable vectorization in Adobe Illustrator and cup printing workflows.</p>
    </div>
    <div class="modal__footer"><button id="btnCloseAbout" class="btn">Close</button></div>
  </dialog>

  <!-- ========= App ========= -->
  <script src="app.js"></script>
</body>
</html>
