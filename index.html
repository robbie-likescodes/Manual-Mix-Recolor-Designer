<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cup Mapper</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <!-- ============== Topbar ============== -->
  <header class="topbar">
    <div class="topbar__left">
      <h1 class="app-title">Cup Mapper <span class="app-subtitle">Image → Limited Inks</span></h1>
    </div>
    <div class="topbar__right">
      <button id="btnOpenHelp" class="btn">Help</button>
      <button id="btnOpenAbout" class="btn">About</button>
    </div>
  </header>

  <!-- ============== Layout ============== -->
  <div class="layout">

    <!-- -------- Left panel: Controls -------- -->
    <div class="panel panel--controls">
      
      <!-- Stage 1: Upload -->
      <div class="card">
        <div class="card__header">
          <h2>1. Upload image</h2>
          <p class="muted">AI art or selfie → start here</p>
        </div>
        <div class="card__body">
          <!-- Hero preview -->
          <div class="heroWrap">
            <canvas id="heroCanvas" width="0" height="0" aria-label="Original image preview"></canvas>
          </div>

          <div class="uploader">
            <input id="fileInput" type="file" accept="image/*" />
            <div class="uploader__row">
              <label>Max width <input id="maxW" type="number" value="1600" /></label>
              <button id="btnClear" class="btn">Clear</button>
              <button id="btnLoadSample" class="btn">Load sample</button>
            </div>
          </div>
          <div class="preview-zoom">
            <label>Zoom <input id="zoom" type="range" min="10" max="400" value="100" /></label>
            <span id="zoomLabel">100%</span>
            <button id="btnZoomFit" class="btn">Fit</button>
            <button id="btnZoom100" class="btn">100%</button>
          </div>
        </div>
      </div>

      <!-- Stage 2: Original palette -->
      <div class="card">
        <div class="card__header"><h2>2. Original palette</h2></div>
        <div class="card__body">
          <div class="row wrap">
            <label>Clusters <input id="clusters" type="number" min="2" max="16" value="8" /></label>
            <button id="btnExtract" class="btn">Extract</button>
            <button id="btnEyedrop" class="btn">Eyedrop</button>
          </div>
          <div id="origPalette" class="swatch-grid"></div>
        </div>
      </div>

      <!-- Stage 3: Restricted palette -->
      <div class="card">
        <div class="card__header"><h2>3. Restricted palette</h2></div>
        <div class="card__body">
          <div class="row wrap">
            <button id="btnRefreshRestricted" class="btn">From original</button>
            <label class="switch"><input id="allowWhite" type="checkbox" /> Allow white</label>
            <button id="btnAddRestricted" class="btn">Add</button>
          </div>
          <div id="restrictedPalette" class="swatch-grid"></div>
          <div class="divider"></div>
          <div class="row wrap">
            <button id="btnSaveKit" class="btn">Save kit</button>
            <select id="kitSelect"></select>
            <button id="btnLoadKit" class="btn">Load</button>
            <button id="btnDeleteKit" class="btn btn-danger">Delete</button>
          </div>
        </div>
      </div>

      <!-- Stage 4: Manual mixing -->
      <div class="card">
        <div class="card__header"><h2>4. Manual mixing</h2></div>
        <div class="card__body">
          <label>Replace color
            <select id="replaceSrc"></select>
          </label>
          <label>Block size <input id="blockSize" type="number" value="6" /></label>
          <label>Logical pixel size <input id="mixCellSize" type="number" min="1" value="1" /></label>
          <label>Pattern
            <select id="mixPattern">
              <option value="blue">Blue noise</option>
              <option value="checker">Checker</option>
              <option value="stripes-h">Stripes (horizontal)</option>
              <option value="stripes-v">Stripes (vertical)</option>
              <option value="bayer">Bayer dither</option>
            </select>
          </label>
          <div id="mixInks" class="mix-grid"></div>
          <div class="row">
            <button id="btnAddMixInk" class="btn">Add ink</button>
            <button id="btnClearMix" class="btn btn-danger">Clear</button>
            <span id="mixTotal" class="spacer">Total: 0%</span>
          </div>
          <button id="btnPreviewMix" class="btn-primary">Preview replacement swatch</button>
          <canvas id="mixPreview" width="160" height="80"></canvas>
        </div>
      </div>

      <!-- Stage 5: Mapping -->
      <div class="card">
        <div class="card__header"><h2>5. Map to palette</h2></div>
        <div class="card__body">
          <div class="row wrap">
            <label>ΔL weight <input id="wL" type="number" value="1" /></label>
            <label>ΔC weight <input id="wC" type="number" value="1" /></label>
            <label class="switch"><input id="dither" type="checkbox" /> Dither</label>
            <label class="switch"><input id="sharpen" type="checkbox" /> Sharpen</label>
          </div>
          <button id="btnMap" class="btn-primary">Apply mapping</button>
          <div id="mapProgress" class="progress hidden">
            <div class="spinner"></div><span id="mapProgressLabel">Processing…</span>
          </div>
        </div>
      </div>

      <!-- Stage 6: Export -->
      <div class="card">
        <div class="card__header"><h2>6. Export</h2></div>
        <div class="card__body">
          <label>Scale <input id="exportScale" type="number" value="1" min="1" max="4" /></label>
          <label class="switch"><input id="exportTransparent" type="checkbox" /> Transparent</label>
          <div class="row wrap">
            <button id="btnExportPNG" class="btn">Export PNG</button>
            <button id="btnExportSVG" class="btn">Export SVG</button>
            <a id="downloadLink" class="btn" style="display:none">Download</a>
          </div>
        </div>
      </div>

      <!-- Stage 7: Projects -->
      <div class="card">
        <div class="card__header"><h2>7. Projects</h2></div>
        <div class="card__body">
          <div class="row wrap">
            <button id="btnSaveProject" class="btn">Save</button>
            <select id="projectSelect"></select>
            <button id="btnLoadProject" class="btn">Load</button>
            <button id="btnDeleteProject" class="btn btn-danger">Delete</button>
          </div>
        </div>
      </div>
    </div>

    <!-- -------- Right panel: Previews -------- -->
    <div class="panel panel--preview">
      <div class="canvas-stack">

        <figure class="canvas-wrap">
          <figcaption class="figcaption">Source image</figcaption>
          <div id="srcScroll" class="canvas-scroll">
            <canvas id="srcCanvas" width="0" height="0"></canvas>
          </div>
        </figure>

        <figure class="canvas-wrap">
          <figcaption class="figcaption">Mapped image</figcaption>
          <div id="outScroll" class="canvas-scroll">
            <canvas id="outCanvas" width="0" height="0"></canvas>
          </div>
        </figure>
      </div>
    </div>
  </div>

  <!-- ============== Status bar & Toasts ============== -->
  <footer class="statusbar">
    <span id="statusText">Ready</span>
  </footer>
  <div id="toastHost" class="toast-host"></div>

  <!-- ============== Templates ============== -->
  <template id="tplMixRow">
    <div class="mix-row">
      <select class="mix-ink-select"></select>
      <input type="range" class="mix-ink-range" min="0" max="100" value="0" />
      <span class="mix-ink-val">0%</span>
      <button class="mix-ink-remove btn btn-danger">×</button>
    </div>
  </template>

  <!-- ============== Modals ============== -->
  <dialog id="dlgHelp" class="modal">
    <div class="modal__header"><h3>Help</h3></div>
    <div class="modal__body">
      <ol class="help-steps">
        <li>Upload an image (AI art or photo).</li>
        <li>Extract palette, set restricted inks.</li>
        <li>Optional: mix inks or pattern replace.</li>
        <li>Click Apply mapping to reduce colors.</li>
        <li>Export PNG/SVG and refine in Illustrator.</li>
      </ol>
    </div>
    <div class="modal__footer"><button id="btnCloseHelp" class="btn">Close</button></div>
  </dialog>

  <dialog id="dlgAbout" class="modal">
    <div class="modal__header"><h3>About</h3></div>
    <div class="modal__body">
      <p>Cup Mapper — web tool to prep complex art for limited-ink cup printing. Optimized for Adobe Illustrator vectorization.</p>
    </div>
    <div class="modal__footer"><button id="btnCloseAbout" class="btn">Close</button></div>
  </dialog>

  <!-- ============== Script ============== -->
  <script src="app.js"></script>
</body>
</html>
